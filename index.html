<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRICE_LIST</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-size: 24px;
        }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            gap: 5px;
        }
        .tab {
            padding: 12px 30px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            background-color: #e0e0e0;
        }
        .tab.active {
            background-color: #4a6fa5;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 2px dashed #ddd;
        }
        .upload-area {
            text-align: center;
            padding: 20px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-area:hover {
            background-color: #f0f0f0;
        }
        .upload-area i {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .upload-area h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        .upload-area p {
            font-size: 13px;
            margin: 3px 0;
        }
        .file-input {
            display: none;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .db-info {
            margin-top: 10px;
            padding: 8px;
            background-color: #e7f3ff;
            border-radius: 4px;
            display: none;
            font-size: 13px;
        }
        .db-info h4 {
            margin-bottom: 3px;
            color: #0066cc;
            font-size: 14px;
        }
        .db-info p {
            margin: 2px 0;
            font-size: 12px;
        }
        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: none;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .field-note {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
            margin-bottom: 5px;
            font-style: italic;
        }
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            grid-column: 1 / -1;
        }
        button {
            padding: 10px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        button:hover {
            background-color: #3a5a80;
        }
        .reset-btn {
            background-color: #6c757d;
        }
        .reset-btn:hover {
            background-color: #545b62;
        }
        .results {
            margin-top: 20px;
        }
        .sort-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .sort-controls label {
            font-size: 14px;
            color: #555;
            font-weight: normal;
        }
        .sort-controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-break: keep-all;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .price-value {
            color: #dc3545;
            font-weight: bold;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            .tabs {
                gap: 3px;
            }
            .tab {
                padding: 10px 20px;
                font-size: 14px;
            }
            .search-form {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 10px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸”ì„ ì¹´ë“œ í˜•íƒœë¡œ ë³€í™˜ */
            .results h2 {
                font-size: 18px;
            }
            table {
                font-size: 13px;
            }
            table thead {
                display: none;
            }
            table, table tbody, table tr, table td {
                display: block;
                width: 100%;
            }
            table tr {
                margin-bottom: 20px;
                border: 2px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                background-color: #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            table tr:hover {
                background-color: #f9f9f9;
            }
            table td {
                padding: 10px 0;
                text-align: left;
                border-bottom: 1px solid #f0f0f0;
                display: block;
                white-space: normal;
                word-break: break-word;
                font-weight: bold;
            }
            table td:last-child {
                border-bottom: none;
            }
            table td:before {
                content: attr(data-label) " : ";
                display: inline;
                font-weight: bold;
                color: #333;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PRICE_LIST</h1>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('essa')">ESSA</button>
            <button class="tab" onclick="switchTab('ace')">ACE</button>
        </div>
        
        <!-- ESSA íƒ­ ë‚´ìš© -->
        <div id="essa-tab" class="tab-content active">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea-essa">
                    <div>
                        <i>ğŸ“</i>
                        <h3>SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì—…ë¡œë“œ</h3>
                        <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <p class="file-info">ì§€ì› í˜•ì‹: .db, .sqlite, .sqlite3</p>
                    </div>
                    <input type="file" id="fileInput-essa" class="file-input" accept=".db,.sqlite,.sqlite3">
                </div>
                <div id="statusMessage-essa"></div>
                <div id="dbInfo-essa" class="db-info"></div>
            </div>
            
            <div class="search-form" id="searchForm-essa">
                <div class="form-group">
                    <label for="essa_p_name">ìƒí’ˆëª…</label>
                    <div class="field-note">ì˜ˆ: ì›Œë„ˆë¹„, í‹°ëª¨ì‹œ ë“±</div>
                    <select id="essa_p_name"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_size">ì‚¬ì´ì¦ˆ</label>
                    <div class="field-note">ì˜ˆ: 1ì¸, 2ì¸, 3ì¸ ë“±</div>
                    <select id="essa_size"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_size_option">ì‚¬ì´ì¦ˆ ì˜µì…˜</label>
                    <div class="field-note">ì˜ˆ: ì½”ë„ˆí˜•, ì¹´ìš°ì¹˜í˜• ë“±</div>
                    <select id="essa_size_option"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_material">ì†Œì¬</label>
                    <div class="field-note">ì˜ˆ: ê°€ì£½, íŒ¨ë¸Œë¦­ ë“±</div>
                    <select id="essa_material"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_fabric">ì›ë‹¨</label>
                    <div class="field-note">ì˜ˆ: ì¹´ì‹œë¯¸ë¼, ë¦¬ë¸Œ ë“±</div>
                    <select id="essa_fabric"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_function">ê¸°ëŠ¥</label>
                    <div class="field-note">ì˜ˆ: ìŠ¤ìœ™, í—¤ë“œ, ë¦¬í”„íŠ¸ ë“±</div>
                    <select id="essa_function"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_stool">ìŠ¤íˆ´ í¬í•¨</label>
                    <div class="field-note">ì˜ˆ: í¬í•¨, ì¼ë°˜</div>
                    <select id="essa_stool"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_style">ìŠ¤íƒ€ì¼</label>
                    <div class="field-note">ì˜ˆ: ì½¤ë¹„, ì¼ë°˜</div>
                    <select id="essa_style"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_leather_option">ê°€ì£½ ì˜µì…˜</label>
                    <div class="field-note">ì˜ˆ: ì „ë©´, ì „ì²´</div>
                    <select id="essa_leather_option"><option value="">ì „ì²´</option></select>
                </div>
                <div class="form-group">
                    <label for="essa_event_product">í–‰ì‚¬ ì œí’ˆ</label>
                    <div class="field-note">ì˜ˆ: ì •ìƒ, í–‰ì‚¬</div>
                    <select id="essa_event_product"><option value="">ì „ì²´</option></select>
                </div>
                <div class="buttons">
                    <button onclick="searchProducts('essa')">ê²€ìƒ‰</button>
                    <button onclick="resetForm('essa')" class="reset-btn">ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="loading" id="loading-essa">ğŸ” ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div class="results">
                <h2>ê²€ìƒ‰ ê²°ê³¼</h2>
                <div id="results-container-essa"></div>
            </div>
        </div>
        
        <!-- ACE íƒ­ ë‚´ìš© -->
        <div id="ace-tab" class="tab-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea-ace">
                    <div>
                        <i>ğŸ“</i>
                        <h3>SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì—…ë¡œë“œ</h3>
                        <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <p class="file-info">ì§€ì› í˜•ì‹: .db, .sqlite, .sqlite3</p>
                    </div>
                    <input type="file" id="fileInput-ace" class="file-input" accept=".db,.sqlite,.sqlite3">
                </div>
                <div id="statusMessage-ace"></div>
                <div id="dbInfo-ace" class="db-info"></div>
            </div>
            
            <div class="search-form" id="searchForm-ace">
                <!-- 1. í”„ë ˆì„ -->
                <div class="form-group">
                    <label for="ace_frame">í”„ë ˆì„</label>
                    <div class="field-note">í”„ë ˆì„ ì„ íƒì‹œ í•´ë‹¹ íƒ€ì…/ì‚¬ì´ì¦ˆ í‘œì‹œ</div>
                    <select id="ace_frame" onchange="updateDependentOptions('ace')"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 2. íƒ€ì… -->
                <div class="form-group">
                    <label for="ace_type">íƒ€ì…</label>
                    <div class="field-note">í”„ë ˆì„ ì„ íƒ ì‹œ ì—°ë™ë¨</div>
                    <select id="ace_type"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 3. ë§¤íŠ¸ë¦¬ìŠ¤ -->
                <div class="form-group">
                    <label for="ace_mattress">ë§¤íŠ¸ë¦¬ìŠ¤</label>
                    <div class="field-note">í”„ë ˆì„ ë¯¸ì„ íƒ ì‹œ ì‚¬ì´ì¦ˆì™€ ì—°ë™ë¨</div>
                    <select id="ace_mattress" onchange="updateDependentOptions('ace')"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 4. ì‚¬ì´ì¦ˆ -->
                <div class="form-group">
                    <label for="ace_size">ì‚¬ì´ì¦ˆ</label>
                    <div class="field-note">í”„ë ˆì„ ë˜ëŠ” ë§¤íŠ¸ë¦¬ìŠ¤ ì„ íƒ ì‹œ ì—°ë™ë¨</div>
                    <select id="ace_size"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 5. í˜‘íƒ -->
                <div class="form-group">
                    <label for="ace_nightstand">í˜‘íƒ</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_nightstand"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 6. ì‚¬ì´ë“œë³´ë“œ -->
                <div class="form-group">
                    <label for="ace_sideboard">ì‚¬ì´ë“œë³´ë“œ</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_sideboard"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 7. í˜‘íƒ + ì‚¬ì´ë“œë³´ë“œ -->
                <div class="form-group">
                    <label for="ace_nightstand_sideboard">í˜‘íƒ + ì‚¬ì´ë“œë³´ë“œ</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_nightstand_sideboard"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 8. ê°€êµ¬ -->
                <div class="form-group">
                    <label for="ace_furniture">ê°€êµ¬</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_furniture"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 9. ì—°ê³„ í’ˆëª© -->
                <div class="form-group">
                    <label for="ace_related_items">ì—°ê³„ í’ˆëª©</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_related_items"><option value="">ì „ì²´</option></select>
                </div>
                <!-- 10. êµ¬ë¶„ -->
                <div class="form-group">
                    <label for="ace_category">êµ¬ë¶„</label>
                    <div class="field-note">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìë™ ë¡œë“œ</div>
                    <select id="ace_category"><option value="">ì „ì²´</option></select>
                </div>
                <div class="buttons">
                    <button onclick="searchProducts('ace')">ê²€ìƒ‰</button>
                    <button onclick="resetForm('ace')" class="reset-btn">ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="loading" id="loading-ace">ğŸ” ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div class="results">
                <h2>ê²€ìƒ‰ ê²°ê³¼</h2>
                <div id="results-container-ace"></div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            SQLJSCDN: 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0',
            ALLOWED_EXTENSIONS: /\.(db|sqlite|sqlite3)$/i,
            FIELD_MAPPING: {
                essa: {
                    p_name: ['P_NAME', 'ìƒí’ˆëª…', 'PRODUCT_NAME', 'NAME'],
                    size: ['SIZE', 'ì‚¬ì´ì¦ˆ'],
                    size_option: ['SIZE ì˜µì…˜', 'SIZE_OPTION', 'ì‚¬ì´ì¦ˆì˜µì…˜', 'ì‚¬ì´ì¦ˆ ì˜µì…˜', 'SIZEOPTION'],
                    material: ['MATERIAL', 'ì†Œì¬'],
                    fabric: ['FABRIC', 'ì›ë‹¨'],
                    function: ['FUNCTION', 'ê¸°ëŠ¥'],
                    stool: ['ìŠ¤íˆ´í¬í•¨', 'STOOL', 'ìŠ¤íˆ´', 'ìŠ¤íˆ´ í¬í•¨', 'STOOL í¬í•¨', 'STOOLí¬í•¨'],
                    style: ['STYLE', 'ìŠ¤íƒ€ì¼'],
                    leather_option: ['ê°€ì£½ì˜µì…˜', 'LEATHER_OPTION', 'ê°€ì£½ ì˜µì…˜', 'LEATHEROPTION'],
                    event_product: ['í–‰ì‚¬ì œí’ˆ', 'í–‰ì‚¬ ì œí’ˆ', 'EVENT_PRODUCT', 'EVENT', 'ì´ë²¤íŠ¸']
                },
                ace: {
                    frame: ['í”„ë ˆì„', 'FRAME', 'FRAME_TYPE', 'í”„ë ˆì„íƒ€ì…'],
                    type: ['íƒ€ì…', 'TYPE', 'TYPE_NM', 'BED_TYPE'],
                    mattress: ['ë§¤íŠ¸ë¦¬ìŠ¤', 'MATTRESS', 'MATTRESS_TYPE', 'ë§¤íŠ¸ë¦¬ìŠ¤íƒ€ì…'],
                    size: ['SIZE', 'ì‚¬ì´ì¦ˆ', 'BED_SIZE'],
                    nightstand: ['í˜‘íƒ', 'NIGHTSTAND', 'í˜‘íƒí¬í•¨', 'NIGHTSTAND_YN'],
                    sideboard: ['ì‚¬ì´ë“œë³´ë“œ', 'SIDEBOARD', 'ì‚¬ì´ë“œë³´ë“œí¬í•¨', 'SIDEBOARD_YN'],
                    nightstand_sideboard: ['í˜‘íƒ+ì‚¬ì´ë“œë³´ë“œ', 'í˜‘íƒ + ì‚¬ì´ë“œë³´ë“œ', 'NIGHTSTAND_SIDEBOARD', 'í˜‘íƒì‚¬ì´ë“œë³´ë“œ', 'NIGHTSIDE'],
                    furniture: ['ê°€êµ¬', 'FURNITURE', 'FURNITURE_TYPE', 'ê°€êµ¬íƒ€ì…'],
                    related_items: ['ì—°ê³„ í’ˆëª©', 'ì—°ê³„í’ˆëª©', 'RELATED_ITEMS', 'ì—°ê³„', 'RELATED_PRODUCTS', 'ì—°ê³„í’ˆëª©ì½”ë“œ', 'RELATED_ITEM_CODE'],
                    category: ['êµ¬ë¶„', 'CATEGORY', 'CATEGORY_NM', 'ë¶„ë¥˜']
                }
            },
            DISPLAY_COLUMNS: {
                essa: [
                    { keys: ['í’ˆëª©ì½”ë“œ', 'PRODUCT_CODE', 'CODE', 'ì½”ë“œ'], label: 'í’ˆëª©ì½”ë“œ' },
                    { keys: ['ìƒí’ˆëª…', 'P_NAME', 'PRODUCT_NAME', 'NAME'], label: 'ìƒí’ˆëª…' },
                    { keys: ['ì‚¬ì´ì¦ˆ', 'SIZE'], label: 'ì‚¬ì´ì¦ˆ' },
                    { keys: ['íŒë§¤ê°€', 'PRICE', 'SALE_PRICE', 'ê°€ê²©'], label: 'íŒë§¤ê°€' },
                    { keys: ['í–‰ì‚¬ì œí’ˆ', 'í–‰ì‚¬ ì œí’ˆ', 'EVENT_PRODUCT', 'EVENT', 'ì´ë²¤íŠ¸'], label: 'í–‰ì‚¬ì œí’ˆ' }
                ],
                ace: [
                    { keys: ['ë¸Œëœë“œ', 'BRAND', 'BRAND_NM'], label: 'ë¸Œëœë“œ' },
                    { keys: ['ìƒí’ˆëª…', 'P_NAME', 'PRODUCT_NAME', 'NAME'], label: 'ìƒí’ˆëª…' },
                    { keys: ['ì‚¬ì´ì¦ˆ', 'SIZE', 'BED_SIZE'], label: 'ì‚¬ì´ì¦ˆ' },
                    { keys: ['ìƒ‰ìƒ', 'COLOR', 'COLOR_NM', 'ìƒ‰ìƒëª…'], label: 'ìƒ‰ìƒ' },
                    { keys: ['íŒë§¤ê°€', 'PRICE', 'SALE_PRICE', 'ê°€ê²©', 'ê¸ˆì•¡'], label: 'íŒë§¤ê°€' }
                ]
            },
            TABLE_CONFIG: {
                essa: 'DATA',
                ace: 'DATA_1'
            }
        };

        const state = {
            essa: { db: null, fileName: '', tableInfo: null, currentProducts: [], currentSort: 'none' },
            ace: { db: null, fileName: '', tableInfo: null, currentProducts: [], currentSort: 'none' }
        };

        // SIZE ê°’ ì •ê·œí™” í•¨ìˆ˜
        function normalizeSizeValue(size) {
            if (!size) return null;
            
            let normalized = size.toString().trim();
            
            // "1ì¸" í˜•íƒœë¡œ í‘œì¤€í™”
            if (normalized.match(/^\d+\s*(ì¸|äºº|IN)$/i)) {
                const num = normalized.match(/^\d+/)[0];
                return `${num}ì¸`;
            }
            
            // "SS", "S", "M", "L" ë“± ì‚¬ì´ì¦ˆ ì½”ë“œ
            if (normalized.match(/^[A-Z]{1,3}$/i)) {
                return normalized.toUpperCase();
            }
            
            return normalized;
        }

        // SIZE ê°’ ë¹„êµ í•¨ìˆ˜
        function compareSizeValues(a, b) {
            // ìˆ«ì ì¶”ì¶œ
            const numA = a.match(/\d+/)?.[0] || 0;
            const numB = b.match(/\d+/)?.[0] || 0;
            
            // ìˆ«ìê°€ ìˆëŠ” ê²½ìš° ìˆ«ì ê¸°ì¤€ ì •ë ¬
            if (numA !== numB) {
                return parseInt(numA) - parseInt(numB);
            }
            
            // ìˆ«ìê°€ ê°™ì€ ê²½ìš° ë¬¸ìì—´ ì •ë ¬
            return a.localeCompare(b);
        }

        // ì¢…ì† ì˜µì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDependentOptions(tabName) {
            if (!state[tabName].db || !state[tabName].tableInfo) return;

            const frameValue = document.getElementById(`${tabName}_frame`).value;
            const mattressValue = document.getElementById(`${tabName}_mattress`).value;

            // í”„ë ˆì„ì´ ì„ íƒëœ ê²½ìš°: í•´ë‹¹ í”„ë ˆì„ì— ë§ëŠ” íƒ€ì…ê³¼ ì‚¬ì´ì¦ˆ í‘œì‹œ
            if (frameValue) {
                updateTypeOptions(tabName, frameValue);
                updateSizeOptionsByFrame(tabName, frameValue);
            }
            // í”„ë ˆì„ì´ ì„ íƒë˜ì§€ ì•Šê³  ë§¤íŠ¸ë¦¬ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°: í•´ë‹¹ ë§¤íŠ¸ë¦¬ìŠ¤ì— ë§ëŠ” ì‚¬ì´ì¦ˆ í‘œì‹œ
            else if (mattressValue) {
                updateSizeOptionsByMattress(tabName, mattressValue);
            }
            // ì•„ë¬´ê²ƒë„ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°: ëª¨ë“  ì˜µì…˜ í‘œì‹œ
            else {
                resetDependentOptions(tabName);
            }
        }

        function updateTypeOptions(tabName, frameValue) {
            const frameCol = findMatchingColumn('frame', tabName);
            const typeCol = findMatchingColumn('type', tabName);
            
            if (!frameCol || !typeCol) return;

            const actualFrameCol = getActualColumnName(frameCol, tabName);
            const actualTypeCol = getActualColumnName(typeCol, tabName);
            const safeFrameCol = getSafeColumnName(actualFrameCol);
            const safeTypeCol = getSafeColumnName(actualTypeCol);

            try {
                const query = `SELECT DISTINCT ${safeTypeCol} FROM ${state[tabName].tableInfo.name} WHERE ${safeFrameCol} = ? AND ${safeTypeCol} IS NOT NULL AND ${safeTypeCol} != '' ORDER BY ${safeTypeCol}`;
                const result = state[tabName].db.exec(query, [frameValue]);

                const selectElement = document.getElementById(`${tabName}_type`);
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">ì „ì²´</option>';

                if (result.length > 0 && result[0].values.length > 0) {
                    const uniqueValues = [];
                    result[0].values.forEach(row => {
                        const value = row[0];
                        if (value && value.toString().trim() !== '') {
                            uniqueValues.push(value.toString().trim());
                        }
                    });

                    const sortedUniqueValues = [...new Set(uniqueValues)].sort();
                    
                    sortedUniqueValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });

                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = `í”„ë ˆì„ ì„ íƒì‹œ í•´ë‹¹ íƒ€ì… í‘œì‹œ (${sortedUniqueValues.length}ê°œ)`;
                    }
                } else {
                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = 'í•´ë‹¹ í”„ë ˆì„ì— ë§ëŠ” íƒ€ì…ì´ ì—†ìŠµë‹ˆë‹¤';
                    }
                }
            } catch (error) {
                console.error('Error updating type options:', error);
            }
        }

        function updateSizeOptionsByFrame(tabName, frameValue) {
            const frameCol = findMatchingColumn('frame', tabName);
            const sizeCol = findMatchingColumn('size', tabName);
            
            if (!frameCol || !sizeCol) return;

            const actualFrameCol = getActualColumnName(frameCol, tabName);
            const actualSizeCol = getActualColumnName(sizeCol, tabName);
            const safeFrameCol = getSafeColumnName(actualFrameCol);
            const safeSizeCol = getSafeColumnName(actualSizeCol);

            try {
                const query = `SELECT DISTINCT ${safeSizeCol} FROM ${state[tabName].tableInfo.name} WHERE ${safeFrameCol} = ? AND ${safeSizeCol} IS NOT NULL AND ${safeSizeCol} != '' ORDER BY ${safeSizeCol}`;
                const result = state[tabName].db.exec(query, [frameValue]);

                const selectElement = document.getElementById(`${tabName}_size`);
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">ì „ì²´</option>';

                if (result.length > 0 && result[0].values.length > 0) {
                    const uniqueValues = [];
                    result[0].values.forEach(row => {
                        const value = row[0];
                        if (value && value.toString().trim() !== '') {
                            uniqueValues.push(value.toString().trim());
                        }
                    });

                    const sortedUniqueValues = [...new Set(uniqueValues)].sort();
                    
                    sortedUniqueValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });

                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = `í”„ë ˆì„ ì„ íƒì‹œ í•´ë‹¹ ì‚¬ì´ì¦ˆ í‘œì‹œ (${sortedUniqueValues.length}ê°œ)`;
                    }
                } else {
                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = 'í•´ë‹¹ í”„ë ˆì„ì— ë§ëŠ” ì‚¬ì´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤';
                    }
                }
            } catch (error) {
                console.error('Error updating size options by frame:', error);
            }
        }

        function updateSizeOptionsByMattress(tabName, mattressValue) {
            const mattressCol = findMatchingColumn('mattress', tabName);
            const sizeCol = findMatchingColumn('size', tabName);
            
            if (!mattressCol || !sizeCol) return;

            const actualMattressCol = getActualColumnName(mattressCol, tabName);
            const actualSizeCol = getActualColumnName(sizeCol, tabName);
            const safeMattressCol = getSafeColumnName(actualMattressCol);
            const safeSizeCol = getSafeColumnName(actualSizeCol);

            try {
                const query = `SELECT DISTINCT ${safeSizeCol} FROM ${state[tabName].tableInfo.name} WHERE ${safeMattressCol} = ? AND ${safeSizeCol} IS NOT NULL AND ${safeSizeCol} != '' ORDER BY ${safeSizeCol}`;
                const result = state[tabName].db.exec(query, [mattressValue]);

                const selectElement = document.getElementById(`${tabName}_size`);
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">ì „ì²´</option>';

                if (result.length > 0 && result[0].values.length > 0) {
                    const uniqueValues = [];
                    result[0].values.forEach(row => {
                        const value = row[0];
                        if (value && value.toString().trim() !== '') {
                            uniqueValues.push(value.toString().trim());
                        }
                    });

                    const sortedUniqueValues = [...new Set(uniqueValues)].sort();
                    
                    sortedUniqueValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });

                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = `ë§¤íŠ¸ë¦¬ìŠ¤ ì„ íƒì‹œ í•´ë‹¹ ì‚¬ì´ì¦ˆ í‘œì‹œ (${sortedUniqueValues.length}ê°œ)`;
                    }
                } else {
                    const fieldNote = selectElement.parentNode.querySelector('.field-note');
                    if (fieldNote) {
                        fieldNote.textContent = 'í•´ë‹¹ ë§¤íŠ¸ë¦¬ìŠ¤ì— ë§ëŠ” ì‚¬ì´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤';
                    }
                }
            } catch (error) {
                console.error('Error updating size options by mattress:', error);
            }
        }

        function resetDependentOptions(tabName) {
            // íƒ€ì… ì˜µì…˜ ì´ˆê¸°í™”
            const typeSelect = document.getElementById(`${tabName}_type`);
            typeSelect.innerHTML = '<option value="">ì „ì²´</option>';
            const typeFieldNote = typeSelect.parentNode.querySelector('.field-note');
            if (typeFieldNote) {
                typeFieldNote.textContent = 'í”„ë ˆì„ ì„ íƒ ì‹œ ì—°ë™ë¨';
            }

            // ì‚¬ì´ì¦ˆ ì˜µì…˜ ì´ˆê¸°í™”
            const sizeSelect = document.getElementById(`${tabName}_size`);
            sizeSelect.innerHTML = '<option value="">ì „ì²´</option>';
            const sizeFieldNote = sizeSelect.parentNode.querySelector('.field-note');
            if (sizeFieldNote) {
                sizeFieldNote.textContent = 'í”„ë ˆì„ ë˜ëŠ” ë§¤íŠ¸ë¦¬ìŠ¤ ì„ íƒ ì‹œ ì—°ë™ë¨';
            }

            // ëª¨ë“  ì˜µì…˜ ë‹¤ì‹œ ì±„ìš°ê¸°
            populateAllOptions(tabName);
        }

        function populateAllOptions(tabName) {
            const fieldMapping = CONFIG.FIELD_MAPPING[tabName];
            
            Object.keys(fieldMapping).forEach(fieldKey => {
                if (fieldKey !== 'type' && fieldKey !== 'size') { // typeê³¼ sizeëŠ” ë³„ë„ë¡œ ì²˜ë¦¬
                    const matchedCol = findMatchingColumn(fieldKey, tabName);
                    if (matchedCol) {
                        const actualCol = getActualColumnName(matchedCol, tabName);
                        const safeCol = getSafeColumnName(actualCol);
                        
                        try {
                            const query = `SELECT DISTINCT ${safeCol} FROM ${state[tabName].tableInfo.name} WHERE ${safeCol} IS NOT NULL AND ${safeCol} != '' ORDER BY ${safeCol}`;
                            const result = state[tabName].db.exec(query);
                            
                            const selectElement = document.getElementById(`${tabName}_${fieldKey}`);
                            const currentValue = selectElement.value;
                            selectElement.innerHTML = '<option value="">ì „ì²´</option>';
                            
                            if (result.length > 0 && result[0].values.length > 0) {
                                const uniqueValues = [];
                                result[0].values.forEach(row => {
                                    const value = row[0];
                                    if (value && value.toString().trim() !== '') {
                                        uniqueValues.push(value.toString().trim());
                                    }
                                });
                                
                                const sortedUniqueValues = [...new Set(uniqueValues)].sort();
                                
                                sortedUniqueValues.forEach(value => {
                                    const option = document.createElement('option');
                                    option.value = value;
                                    option.textContent = value;
                                    if (value === currentValue) {
                                        option.selected = true;
                                    }
                                    selectElement.appendChild(option);
                                });
                                
                                const fieldNote = selectElement.parentNode.querySelector('.field-note');
                                if (fieldNote && fieldKey !== 'frame' && fieldKey !== 'mattress') {
                                    fieldNote.textContent = `ì´ ${sortedUniqueValues.length}ê°œ ì˜µì…˜`;
                                }
                            }
                        } catch (error) {
                            console.error(`Error populating ${fieldKey}:`, error);
                        }
                    }
                }
            });
            
            // SIZE ì˜µì…˜ ë³„ë„ ì²˜ë¦¬
            populateSizeOptions(tabName);
        }

        function populateSizeOptions(tabName) {
            const sizeSelect = document.getElementById(`${tabName}_size`);
            sizeSelect.innerHTML = '<option value="">ì „ì²´</option>';
            
            if (!state[tabName].db || !state[tabName].tableInfo) return;
            
            const matchedCol = findMatchingColumn('size', tabName);
            if (matchedCol) {
                const actualCol = getActualColumnName(matchedCol, tabName);
                const safeCol = getSafeColumnName(actualCol);
                
                try {
                    // SIZE í•„ë“œì˜ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                    const query = `SELECT DISTINCT ${safeCol} FROM ${state[tabName].tableInfo.name} 
                                 WHERE ${safeCol} IS NOT NULL AND TRIM(${safeCol}) != '' 
                                 ORDER BY ${safeCol}`;
                    
                    console.log(`[${tabName}] SIZE ì¿¼ë¦¬:`, query);
                    const result = state[tabName].db.exec(query);
                    
                    if (result.length > 0 && result[0].values.length > 0) {
                        const uniqueValues = [];
                        result[0].values.forEach(row => {
                            const value = row[0];
                            if (value && value.toString().trim() !== '') {
                                const normalized = normalizeSizeValue(value.toString().trim());
                                if (normalized) {
                                    uniqueValues.push(normalized);
                                }
                            }
                        });
                        
                        const sortedUniqueValues = [...new Set(uniqueValues)].sort(compareSizeValues);
                        
                        sortedUniqueValues.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            sizeSelect.appendChild(option);
                        });
                        
                        console.log(`[${tabName}] SIZE ì˜µì…˜ ë¡œë“œ ì™„ë£Œ:`, sortedUniqueValues);
                        
                        // í•„ë“œ ë…¸íŠ¸ ì—…ë°ì´íŠ¸
                        const fieldNote = sizeSelect.parentNode.querySelector('.field-note');
                        if (fieldNote) {
                            fieldNote.textContent = `ì´ ${sortedUniqueValues.length}ê°œ ì˜µì…˜`;
                        }
                    } else {
                        console.log(`[${tabName}] SIZE ê°’ì´ ì—†ìŒ`);
                    }
                } catch (error) {
                    console.error(`Error populating size for ${tabName}:`, error);
                }
            } else {
                console.log(`[${tabName}] SIZE ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ì´ˆê¸°í™”
        function initTab(tabName) {
            const uploadArea = document.getElementById(`uploadArea-${tabName}`);
            const fileInput = document.getElementById(`fileInput-${tabName}`);
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f0f0';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0], tabName);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) handleFileUpload(e.target.files[0], tabName);
            });
        }

        function handleFileUpload(file, tabName) {
            if (!CONFIG.ALLOWED_EXTENSIONS.test(file.name)) {
                showStatus('SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼(.db, .sqlite, .sqlite3)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error', tabName);
                return;
            }
            showStatus('íŒŒì¼ì„ ì½ëŠ” ì¤‘...', 'info', tabName);
            
            const reader = new FileReader();
            reader.onload = e => loadDatabase(e.target.result, file.name, tabName);
            reader.onerror = () => showStatus('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error', tabName);
            reader.readAsArrayBuffer(file);
        }

        async function loadDatabase(arrayBuffer, fileName, tabName) {
            try {
                showStatus('SQL.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œ ì¤‘...', 'info', tabName);
                if (typeof initSqlJs === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `${CONFIG.SQLJSCDN}/sql-wasm.js`;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                
                const SQL = await initSqlJs({
                    locateFile: file => `${CONFIG.SQLJSCDN}/${file}`
                });
                
                state[tabName].db = new SQL.Database(new Uint8Array(arrayBuffer));
                state[tabName].fileName = fileName;
                
                analyzeDatabase(tabName);
            } catch (error) {
                showStatus('ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error', tabName);
            }
        }

        function analyzeDatabase(tabName) {
            try {
                const targetTable = CONFIG.TABLE_CONFIG[tabName];
                
                // ì§€ì •ëœ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const tableCheck = state[tabName].db.exec(
                    `SELECT name FROM sqlite_master WHERE type='table' AND name='${targetTable}'`
                );
                
                if (!tableCheck.length || !tableCheck[0].values.length) {
                    showStatus(`ë°ì´í„°ë² ì´ìŠ¤ì— ${targetTable} í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.`, 'error', tabName);
                    return;
                }

                const columns = state[tabName].db.exec(`PRAGMA table_info(${targetTable})`);
                
                state[tabName].tableInfo = {
                    name: targetTable,
                    columns: columns[0].values.map(col => col[1])
                };

                const rowCount = state[tabName].db.exec(`SELECT COUNT(*) FROM ${targetTable}`);
                const count = rowCount[0].values[0][0];
                
                // í…Œì´ë¸” ìƒ˜í”Œ ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)
                try {
                    const sampleData = state[tabName].db.exec(`SELECT * FROM ${targetTable} LIMIT 1`);
                    if (sampleData.length > 0 && sampleData[0].columns) {
                        console.log(`[${tabName}] í…Œì´ë¸” ì»¬ëŸ¼:`, sampleData[0].columns);
                        
                        // SIZE ì»¬ëŸ¼ í™•ì¸
                        const sizeColIndex = sampleData[0].columns.findIndex(col => 
                            col.toUpperCase().includes('SIZE') || col.includes('ì‚¬ì´ì¦ˆ')
                        );
                        if (sizeColIndex >= 0) {
                            console.log(`[${tabName}] SIZE ì»¬ëŸ¼ ë°œê²¬:`, 
                                sampleData[0].columns[sizeColIndex], 
                                'ê°’:', sampleData[0].values[0][sizeColIndex]
                            );
                        }
                    }
                } catch (e) {
                    console.log('ìƒ˜í”Œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', e);
                }

                showStatus(`"${state[tabName].fileName}" ë¡œë“œ ì™„ë£Œ! ì˜µì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`, 'info', tabName);
                displayDatabaseInfo(targetTable, count, tabName);
                populateAllOptions(tabName);
                
                document.getElementById(`searchForm-${tabName}`).style.display = 'grid';
                showStatus(`"${state[tabName].fileName}" ë¡œë“œ ì™„ë£Œ! ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'success', tabName);
            } catch (error) {
                showStatus('ë°ì´í„°ë² ì´ìŠ¤ ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'error', tabName);
            }
        }

        function displayDatabaseInfo(tableName, count, tabName) {
            document.getElementById(`dbInfo-${tabName}`).innerHTML = `
                <h4>ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´</h4>
                <p>í…Œì´ë¸”: ${tableName} | ë ˆì½”ë“œ ìˆ˜: ${count}ê°œ</p>
                <p>ì»¬ëŸ¼: ${state[tabName].tableInfo.columns.join(', ')}</p>
            `;
            document.getElementById(`dbInfo-${tabName}`).style.display = 'block';
        }

        function showStatus(message, type, tabName) {
            document.getElementById(`statusMessage-${tabName}`).innerHTML = 
                `<div class="status-message ${type}">${message}</div>`;
        }

        function searchProducts(tabName) {
            if (!state[tabName].db || !state[tabName].tableInfo) {
                showStatus('ë¨¼ì € ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error', tabName);
                return;
            }

            document.getElementById(`loading-${tabName}`).style.display = 'block';
            document.getElementById(`results-container-${tabName}`).innerHTML = '';
            
            setTimeout(() => {
                try {
                    const searchParams = {};
                    const fieldMapping = CONFIG.FIELD_MAPPING[tabName];
                    
                    Object.keys(fieldMapping).forEach(key => {
                        const value = document.getElementById(`${tabName}_${key}`).value;
                        if (value) searchParams[key] = value;
                    });
                    
                    const products = performSearch(searchParams, tabName);
                    state[tabName].currentProducts = products;
                    state[tabName].currentSort = 'none';
                    displayResults(products, tabName);
                } catch (error) {
                    document.getElementById(`results-container-${tabName}`).innerHTML = 
                        `<div class="no-results">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ${error.message}</div>`;
                } finally {
                    document.getElementById(`loading-${tabName}`).style.display = 'none';
                }
            }, 100);
        }

        function performSearch(searchParams, tabName) {
            let query = `SELECT * FROM ${state[tabName].tableInfo.name} WHERE 1=1`;
            const params = [];
            
            // ESSA íƒ­ê³¼ ACE íƒ­ì— ëŒ€í•œ ê²€ìƒ‰ ë¡œì§ ë¶„ë¦¬
            if (tabName === 'essa') {
                // ESSA íƒ­: ì¼ë°˜ AND ì¡°ê±´ìœ¼ë¡œ ëª¨ë“  í•„í„° ì ìš©
                Object.entries(searchParams).forEach(([key, value]) => {
                    const matchedCol = findMatchingColumn(key, tabName);
                    if (matchedCol) {
                        const actualCol = getActualColumnName(matchedCol, tabName);
                        const safeCol = getSafeColumnName(actualCol);
                        
                        // SIZE ì»¬ëŸ¼ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                        if (key === 'size') {
                            console.log('ESSA SIZE ê²€ìƒ‰:', {
                                key, value, matchedCol, actualCol, safeCol,
                                columns: state[tabName].tableInfo.columns
                            });
                        }
                        
                        query += ` AND ${safeCol} = ?`;
                        params.push(value);
                    } else {
                        // ì»¬ëŸ¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ë¡œê·¸
                        if (key === 'size') {
                            console.log('ESSA SIZE ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', key, 
                                CONFIG.FIELD_MAPPING[tabName][key],
                                'ì‹¤ì œ ì»¬ëŸ¼ë“¤:', state[tabName].tableInfo.columns
                            );
                        }
                    }
                });
            } else if (tabName === 'ace') {
                // ACE íƒ­: ë…¼ë¦¬ì  ê²€ìƒ‰ ì¡°ê±´ ì ìš©
                const frameValue = searchParams.frame;
                const typeValue = searchParams.type;
                const mattressValue = searchParams.mattress;
                const sizeValue = searchParams.size;
                
                // í”„ë ˆì„ê³¼ íƒ€ì…ì´ ëª¨ë‘ ì„ íƒëœ ê²½ìš°: (í”„ë ˆì„ AND íƒ€ì…)
                if (frameValue && typeValue) {
                    const frameCol = findMatchingColumn('frame', tabName);
                    const typeCol = findMatchingColumn('type', tabName);
                    if (frameCol && typeCol) {
                        const actualFrameCol = getActualColumnName(frameCol, tabName);
                        const actualTypeCol = getActualColumnName(typeCol, tabName);
                        const safeFrameCol = getSafeColumnName(actualFrameCol);
                        const safeTypeCol = getSafeColumnName(actualTypeCol);
                        
                        query += ` AND ((${safeFrameCol} = ? AND ${safeTypeCol} = ?)`;
                        params.push(frameValue, typeValue);
                        
                        // ë§¤íŠ¸ë¦¬ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°: OR ë§¤íŠ¸ë¦¬ìŠ¤
                        if (mattressValue) {
                            const mattressCol = findMatchingColumn('mattress', tabName);
                            if (mattressCol) {
                                const actualMattressCol = getActualColumnName(mattressCol, tabName);
                                const safeMattressCol = getSafeColumnName(actualMattressCol);
                                query += ` OR ${safeMattressCol} = ?`;
                                params.push(mattressValue);
                            }
                        }
                        query += `)`;
                    }
                } 
                // í”„ë ˆì„ë§Œ ì„ íƒëœ ê²½ìš°
                else if (frameValue && !typeValue) {
                    const frameCol = findMatchingColumn('frame', tabName);
                    if (frameCol) {
                        const actualFrameCol = getActualColumnName(frameCol, tabName);
                        const safeFrameCol = getSafeColumnName(actualFrameCol);
                        query += ` AND (${safeFrameCol} = ?`;
                        params.push(frameValue);
                        
                        // ë§¤íŠ¸ë¦¬ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°: OR ë§¤íŠ¸ë¦¬ìŠ¤
                        if (mattressValue) {
                            const mattressCol = findMatchingColumn('mattress', tabName);
                            if (mattressCol) {
                                const actualMattressCol = getActualColumnName(mattressCol, tabName);
                                const safeMattressCol = getSafeColumnName(actualMattressCol);
                                query += ` OR ${safeMattressCol} = ?`;
                                params.push(mattressValue);
                            }
                        }
                        query += `)`;
                    }
                }
                // íƒ€ì…ë§Œ ì„ íƒëœ ê²½ìš°
                else if (!frameValue && typeValue) {
                    const typeCol = findMatchingColumn('type', tabName);
                    if (typeCol) {
                        const actualTypeCol = getActualColumnName(typeCol, tabName);
                        const safeTypeCol = getSafeColumnName(actualTypeCol);
                        query += ` AND (${safeTypeCol} = ?`;
                        params.push(typeValue);
                        
                        // ë§¤íŠ¸ë¦¬ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°: OR ë§¤íŠ¸ë¦¬ìŠ¤
                        if (mattressValue) {
                            const mattressCol = findMatchingColumn('mattress', tabName);
                            if (mattressCol) {
                                const actualMattressCol = getActualColumnName(mattressCol, tabName);
                                const safeMattressCol = getSafeColumnName(actualMattressCol);
                                query += ` OR ${safeMattressCol} = ?`;
                                params.push(mattressValue);
                            }
                        }
                        query += `)`;
                    }
                }
                // í”„ë ˆì„ê³¼ íƒ€ì…ì´ ëª¨ë‘ ì„ íƒë˜ì§€ ì•Šê³  ë§¤íŠ¸ë¦¬ìŠ¤ë§Œ ì„ íƒëœ ê²½ìš°
                else if (mattressValue) {
                    const mattressCol = findMatchingColumn('mattress', tabName);
                    if (mattressCol) {
                        const actualMattressCol = getActualColumnName(mattressCol, tabName);
                        const safeMattressCol = getSafeColumnName(actualMattressCol);
                        query += ` AND ${safeMattressCol} = ?`;
                        params.push(mattressValue);
                    }
                }
                
                // ì‚¬ì´ì¦ˆ ì¡°ê±´: AND ì‚¬ì´ì¦ˆ
                if (sizeValue) {
                    const sizeCol = findMatchingColumn('size', tabName);
                    if (sizeCol) {
                        const actualSizeCol = getActualColumnName(sizeCol, tabName);
                        const safeSizeCol = getSafeColumnName(actualSizeCol);
                        query += ` AND ${safeSizeCol} = ?`;
                        params.push(sizeValue);
                    }
                }
                
                // ë‚˜ë¨¸ì§€ ì¡°ê±´ë“¤ (í˜‘íƒ, ì‚¬ì´ë“œë³´ë“œ, ì—°ê³„ í’ˆëª© ë“±)ì€ ì¼ë°˜ AND ì¡°ê±´ìœ¼ë¡œ ì¶”ê°€
                Object.entries(searchParams).forEach(([key, value]) => {
                    if (key !== 'frame' && key !== 'type' && key !== 'mattress' && key !== 'size') {
                        const matchedCol = findMatchingColumn(key, tabName);
                        if (matchedCol) {
                            const actualCol = getActualColumnName(matchedCol, tabName);
                            const safeCol = getSafeColumnName(actualCol);
                            query += ` AND ${safeCol} = ?`;
                            params.push(value);
                        }
                    }
                });
            }
            
            // ì¿¼ë¦¬ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            console.log(`[${tabName}] ìµœì¢… ì¿¼ë¦¬:`, query);
            console.log(`[${tabName}] íŒŒë¼ë¯¸í„°:`, params);
            
            try {
                const stmt = state[tabName].db.prepare(query);
                stmt.bind(params);
                
                const products = [];
                while (stmt.step()) {
                    products.push(stmt.getAsObject());
                }
                
                stmt.free();
                console.log(`[${tabName}] ê²€ìƒ‰ ê²°ê³¼:`, products.length, 'ê°œ');
                return products;
            } catch (error) {
                console.error('Search query error:', error, query, params);
                return [];
            }
        }

        function findMatchingColumn(fieldKey, tabName) {
            const fieldMapping = CONFIG.FIELD_MAPPING[tabName];
            if (!fieldMapping[fieldKey]) {
                console.log(`í•„ë“œ ${fieldKey}ê°€ ë§¤í•‘ì— ì—†ìŒ`);
                return null;
            }
            
            const possibleNames = fieldMapping[fieldKey];
            
            // ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ì •í™•íˆ ë§¤ì¹­
            let matched = possibleNames.find(name => 
                state[tabName].tableInfo.columns.some(col => 
                    col.toUpperCase() === name.toUpperCase()
                )
            );
            
            // ì •í™•í•œ ë§¤ì¹­ì´ ì•ˆë˜ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
            if (!matched && fieldKey === 'size') {
                // "ì‚¬ì´ì¦ˆ"ë‚˜ "SIZE"ê°€ í¬í•¨ëœ ì»¬ëŸ¼ ì°¾ê¸°
                matched = state[tabName].tableInfo.columns.find(col => 
                    col.toUpperCase().includes('SIZE') || col.includes('ì‚¬ì´ì¦ˆ')
                );
                
                if (matched) {
                    console.log(`${tabName} ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ SIZE ì»¬ëŸ¼ ì°¾ìŒ:`, matched);
                }
            }
            
            if (!matched && fieldKey === 'size') {
                console.log(`${tabName} SIZE ì»¬ëŸ¼ ë§¤ì¹­ ì‹¤íŒ¨. ê°€ëŠ¥í•œ ì´ë¦„:`, possibleNames);
                console.log(`${tabName} ì‹¤ì œ ì»¬ëŸ¼ë“¤:`, state[tabName].tableInfo.columns);
            }
            
            return matched;
        }

        function getActualColumnName(matchedCol, tabName) {
            const actual = state[tabName].tableInfo.columns.find(col => 
                col.toUpperCase() === matchedCol.toUpperCase()
            );
            
            if (!actual) {
                console.log(`ì»¬ëŸ¼ ${matchedCol}ì„ ì‹¤ì œ ì»¬ëŸ¼ì—ì„œ ì°¾ì§€ ëª»í•¨`);
                // ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ì°¾ê¸° ì‹œë„
                return state[tabName].tableInfo.columns.find(col => 
                    col.includes(matchedCol) || matchedCol.includes(col)
                ) || matchedCol;
            }
            
            return actual;
        }

        function getSafeColumnName(colName) {
            return /[ -]/.test(colName) ? `[${colName}]` : colName;
        }

        function handleSort(sortType, tabName) {
            if (state[tabName].currentProducts.length === 0) return;
            
            state[tabName].currentSort = sortType;
            let sortedProducts = [...state[tabName].currentProducts];
            
            if (sortType === 'asc' || sortType === 'desc') {
                sortedProducts.sort((a, b) => {
                    const priceA = getPriceValue(a);
                    const priceB = getPriceValue(b);
                    return sortType === 'asc' ? priceA - priceB : priceB - priceA;
                });
            }
            
            displayResults(sortedProducts, tabName);
        }

        function getPriceValue(product) {
            const priceKeys = ['íŒë§¤ê°€', 'PRICE', 'SALE_PRICE', 'ê°€ê²©', 'ê¸ˆì•¡'];
            for (const key of priceKeys) {
                const foundKey = Object.keys(product).find(k => 
                    k.toUpperCase() === key.toUpperCase()
                );
                if (foundKey && product[foundKey]) {
                    const value = product[foundKey];
                    const num = typeof value === 'string' ? parseInt(value.replace(/,/g, '')) : value;
                    return isNaN(num) ? 0 : num;
                }
            }
            return 0;
        }

        function formatPrice(price) {
            if (!price) return "0";
            const num = typeof price === 'string' ? parseInt(price.replace(/,/g, '')) : price;
            return isNaN(num) ? "0" : num.toLocaleString('ko-KR');
        }

        function findColumnValue(product, possibleKeys) {
            for (const key of possibleKeys) {
                const foundKey = Object.keys(product).find(k => 
                    k.toUpperCase() === key.toUpperCase()
                );
                if (foundKey && product[foundKey]) {
                    return product[foundKey];
                }
            }
            return null;
        }

        function displayResults(products, tabName) {
            if (products.length === 0) {
                document.getElementById(`results-container-${tabName}`).innerHTML = 
                    '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let sortHTML = `
                <div class="sort-controls">
                    <label for="sortSelect-${tabName}">ì •ë ¬:</label>
                    <select id="sortSelect-${tabName}" onchange="handleSort(this.value, '${tabName}')">
                        <option value="none" ${state[tabName].currentSort === 'none' ? 'selected' : ''}>ê¸°ë³¸</option>
                        <option value="asc" ${state[tabName].currentSort === 'asc' ? 'selected' : ''}>ê°€ê²© ë‚®ì€ìˆœ</option>
                        <option value="desc" ${state[tabName].currentSort === 'desc' ? 'selected' : ''}>ê°€ê²© ë†’ì€ìˆœ</option>
                    </select>
                </div>
            `;
            
            const displayColumns = CONFIG.DISPLAY_COLUMNS[tabName];
            
            let tableHTML = '<table><thead><tr>';
            displayColumns.forEach(col => {
                tableHTML += `<th>${col.label}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            products.forEach(product => {
                tableHTML += '<tr>';
                displayColumns.forEach(col => {
                    let value = findColumnValue(product, col.keys) || '-';
                    if (col.label === 'íŒë§¤ê°€') {
                        value = formatPrice(value) + 'ì›';
                    }
                    const priceClass = col.label === 'íŒë§¤ê°€' ? ' class="price-value"' : '';
                    tableHTML += `<td data-label="${col.label}"${priceClass}>${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += `</tbody></table>
                <div style="margin-top: 10px; color: #666; font-size: 14px; text-align: center;">
                    ì´ ${products.length}ê°œì˜ ì œí’ˆì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>`;
            
            document.getElementById(`results-container-${tabName}`).innerHTML = sortHTML + tableHTML;
        }

        function resetForm(tabName) {
            const fieldMapping = CONFIG.FIELD_MAPPING[tabName];
            Object.keys(fieldMapping).forEach(key => {
                document.getElementById(`${tabName}_${key}`).value = '';
            });
            document.getElementById(`results-container-${tabName}`).innerHTML = '';
            state[tabName].currentProducts = [];
            state[tabName].currentSort = 'none';
            
            if (tabName === 'ace') {
                resetDependentOptions(tabName);
            } else {
                populateAllOptions(tabName);
            }
        }

        // ESSA íƒ­ ì‚¬ì´ì¦ˆ ì˜µì…˜ ìˆ˜ë™ ì¬ë¡œë“œ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
        function reloadEssaSizeOptions() {
            if (!state.essa.db || !state.essa.tableInfo) return;
            
            console.log('ESSA ì‚¬ì´ì¦ˆ ì˜µì…˜ ì¬ë¡œë“œ ì‹œì‘...');
            
            const sizeSelect = document.getElementById('essa_size');
            sizeSelect.innerHTML = '<option value="">ì „ì²´</option>';
            
            // í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì»¬ëŸ¼ í™•ì¸
            const columnQuery = `PRAGMA table_info(${state.essa.tableInfo.name})`;
            const columns = state.essa.db.exec(columnQuery);
            console.log('ESSA í…Œì´ë¸” ëª¨ë“  ì»¬ëŸ¼:', columns[0]?.values.map(col => col[1]));
            
            // SIZEì™€ ê´€ë ¨ëœ ëª¨ë“  ì»¬ëŸ¼ ì°¾ê¸°
            const sizeColumns = columns[0]?.values
                .map(col => col[1])
                .filter(col => col.toUpperCase().includes('SIZE') || col.includes('ì‚¬ì´ì¦ˆ'));
            
            console.log('ESSA SIZE ê´€ë ¨ ì»¬ëŸ¼:', sizeColumns);
            
            if (sizeColumns.length > 0) {
                // ì²« ë²ˆì§¸ SIZE ì»¬ëŸ¼ ì‚¬ìš©
                const sizeCol = sizeColumns[0];
                const safeCol = getSafeColumnName(sizeCol);
                
                try {
                    const query = `SELECT DISTINCT ${safeCol} FROM ${state.essa.tableInfo.name} 
                                  WHERE ${safeCol} IS NOT NULL AND TRIM(${safeCol}) != ''
                                  ORDER BY ${safeCol}`;
                    
                    console.log('ESSA SIZE ì¿¼ë¦¬:', query);
                    const result = state.essa.db.exec(query);
                    
                    if (result.length > 0 && result[0].values.length > 0) {
                        const uniqueValues = [];
                        result[0].values.forEach(row => {
                            const value = row[0];
                            if (value && value.toString().trim() !== '') {
                                const normalized = normalizeSizeValue(value.toString().trim());
                                if (normalized) {
                                    uniqueValues.push(normalized);
                                }
                            }
                        });
                        
                        const sortedUniqueValues = [...new Set(uniqueValues)].sort(compareSizeValues);
                        
                        sortedUniqueValues.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            sizeSelect.appendChild(option);
                        });
                        
                        console.log('ESSA SIZE ì˜µì…˜ ë¡œë“œ ì™„ë£Œ:', sortedUniqueValues);
                        
                        // í•„ë“œ ë…¸íŠ¸ ì—…ë°ì´íŠ¸
                        const fieldNote = sizeSelect.parentNode.querySelector('.field-note');
                        if (fieldNote) {
                            fieldNote.textContent = `ì´ ${sortedUniqueValues.length}ê°œ ì˜µì…˜ (ì»¬ëŸ¼: ${sizeCol})`;
                        }
                        
                        alert(`ESSA ì‚¬ì´ì¦ˆ ì˜µì…˜ ì¬ë¡œë“œ ì™„ë£Œ! ${sortedUniqueValues.length}ê°œ ì˜µì…˜ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
                    } else {
                        console.log('ESSA SIZE ê°’ ì—†ìŒ');
                        alert('ESSA í…Œì´ë¸”ì— SIZE ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ESSA SIZE ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ESSA ì‚¬ì´ì¦ˆ ì˜µì…˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                }
            } else {
                console.log('ESSA SIZE ì»¬ëŸ¼ ì—†ìŒ');
                alert('ESSA í…Œì´ë¸”ì— SIZE ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
        window.switchTab = switchTab;
        window.searchProducts = searchProducts;
        window.resetForm = resetForm;
        window.handleSort = handleSort;
        window.updateDependentOptions = updateDependentOptions;
        window.reloadEssaSizeOptions = reloadEssaSizeOptions;

        // ì´ˆê¸°í™”
        initTab('essa');
        initTab('ace');
    </script>
</body>
</html>